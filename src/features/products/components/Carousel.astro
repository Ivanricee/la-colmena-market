---
import { Icon } from 'astro-icon/components'
import { Image } from '../products.model'

interface Props {
  images: Image[] | []
}
const { images } = Astro.props
const getImg = (image: Image) => {
  const { version, public_id } = image
  const url = `https://res.cloudinary.com/ivanrice-c/image/upload/ar_3:4,c_pad,dpr_1.0,g_center,q_auto,b_auto,f_auto,w_700/v${version}/${public_id}.webp`
  return url
}
const getImageClass = (index: number) => {
  return `{
    'translate-x-0 z-30': active === ${index},
    '-translate-x-full z-10': active > ${index},
    'translate-x-full z-10': active < ${index},
    'hidden': Math.abs(active - ${index}) > 1 && !(active === 0 && ${index} === total - 1) && !(active === total - 1 && ${index} === 0)
  }`
}
---

<div
  x-data={`{
  active: 0,
  total: ${images.length},
  next() { this.active = (this.active + 1) % this.total },
  prev() { this.active = (this.active - 1 + this.total) % this.total },
  init() {
    if(this.total > 1) {
      let interval = setInterval(() => this.next(), 5000)
      this.$el.addEventListener('mouseenter', () => clearInterval(interval))
      this.$el.addEventListener('mouseleave', () => interval = setInterval(() => this.next(), 5000))
    }
  }
}`}
  class="relative w-full h-full overflow-hidden -top-3"
>
  <!-- Carousel wrapper -->
  <div class="rounded-md relative h-full">
    {
      images.map((image, index) => (
      <div
        class="absolute inset-0 w-full h-full transition-transform duration-700 ease-in-out"
        :class={getImageClass(index)}
      >
        <img
          src={getImg(image)}
          class="drop-shadow-honey-dark/50 h-[calc(100%+1.5rem)] md:h-full w-full md:-translate-y-6 -translate-y-3 md:pb-6 object-contain object-top drop-shadow-lg"
          alt={`Product image ${index + 1}`}
        />
      </div>
      ))
    }
  </div>
  {
    images.length > 1 && (
      <>
        <div class="absolute md:bottom-5 bottom-0.5 left-1/2 z-40 flex -translate-x-1/2 space-x-3 md:bg-secondary/50 bg-secondary/80 p-2 px-4 rounded-full border border-border/30">
          {images.map((_, index) => (
          <button
            type="button"
            @click={`active = ${index}`}
            class="rounded-md h-3 w-3 md:h-3.5 md:w-3.5 transition-colors"
            :class={`active === ${index} ? 'bg-muted-foreground' : 'bg-background/75 hover:bg-muted-foreground/50'`}
          ></button>
          ))}
        </div>

        <button
          @click="prev()"
          class="absolute start-0 top-0 z-40 h-full px-4 group focus:outline-none"
        >
          <span class="rounded-md inline-flex h-11 w-11 md:h-12 md:w-12 items-center justify-center bg-secondary/50 group-hover:bg-secondary border border-border/50">
            <Icon name="lucide:chevron-left" size={24} />
          </span>
        </button>
        <button
          @click="next()"
          class="absolute end-0 top-0 z-40 h-full px-4 group focus:outline-none"
        >
          <span class="rounded-md inline-flex h-11 w-11 md:h-12 md:w-12 items-center justify-center bg-secondary/50 group-hover:bg-secondary border border-border/50">
            <Icon name="lucide:chevron-right" size={24} />
          </span>
        </button>
      </>
    )
  }
</div>
