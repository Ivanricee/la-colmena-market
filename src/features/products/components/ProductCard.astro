---
import Card from '@/components/ui/Card.astro'
import { Icon } from 'astro-icon/components'
import Tags from './Tags.astro'
import { Image, Product } from '../products.model'
import Button from '@/components/ui/Button.astro'
import Tooltip from '@/components/ui/Tooltip.astro'

interface Props {
  product: Product
}
const { product } = Astro.props
const { id, categoryid, tags, title, description, price, previousPrice, image } = product
const slug = categoryid.slug

const productJson = JSON.stringify({
  id: product.id,
  title: product.title,
  price: product.price,
  image: product.image,
  categoryid: product.categoryid,
  purchaseLimit: product.purchaseLimit ?? 10,
})
const getImg = (image: Image) => {
  const { version, public_id } = image
  const url = `https://res.cloudinary.com/ivanrice-c/image/upload/ar_3:4,c_pad,dpr_1.0,g_center,q_auto,b_auto,f_auto,w_300/v${version}/${public_id}.webp`
  return url
}
//transition:name={`bg-img-${id}`}
---

<Card
  data-astro-prefetch
  class="from-card relative flex h-full flex-col bg-linear-to-t to-transparent @sm:flex-row @sm:flex-nowrap"
  transition:name={`card-img-${id}`}
>
  <a href={`/product/${slug || 'uncategorized'}/${id}`} class="flex-1 flex flex-col h-full min-h-0">
    <div class="h-7/12 w-full">
      <div class="relative h-full" transition:name={`bg-img-${id}`}>
        <div
          class:list={[
            'bg-honey-dark/50 @3xs:6/12 from-honey-medium/35 to-honey-dark/25 absolute inset-x-0',
            '-top-6 mx-auto h-[calc(100%+0.8rem)] w-7/12 rounded-b-full bg-linear-to-t @sm:w-5/12',
          ]}
        >
        </div>

        <div
          class:list={[
            'bg-honey-medium/50 group-hover:bg-honey-medium/70 absolute inset-x-0',
            'bottom-3 mx-auto h-40 w-24 rounded-full blur-2xl transition-colors duration-700',
          ]}
        >
        </div>
        <img
          class:list={[
            'drop-shadow-honey-dark/50 group-hover:drop-shadow-honey-dark/90 relative h-full w-full -translate-y-3',
            'object-contain object-top drop-shadow-lg transition-[shadow_transform] duration-300 group-hover:scale-105 group-hover:drop-shadow-xl',
          ]}
          src={getImg(image[0])}
          loading="eager"
          fetchpriority="high"
          alt={title}
        />
      </div>
    </div>
    <div class="flex flex-col overflow-hidden leading-normal px-0 pt-2">
      <div class="mt-5 mb-2" transition:name={`tags-${id}`}>
        <Tags {tags} />
      </div>
      <h4
        class="text-foreground mb-2 line-clamp-1 text-lg font-semibold"
        transition:name={`title-${id}`}
      >
        {title}
      </h4>
      <div
        class="text-muted-foreground line-clamp-2 text-sm text-pretty @sm:text-balance"
        set:html={description}
      />
    </div>
  </a>
  <div class="flex flex-nowrap items-center justify-between gap-2 mt-3">
    <p class="flex items-baseline gap-2" transition:name={`price-${id}`}>
      <span
        class="from-primary bg-linear-to-r to-orange-400 bg-clip-text text-2xl font-bold text-transparent"
      >
        ${price}
      </span>
      {
        previousPrice && (
          <span class="text-muted-foreground text-sm line-through">${previousPrice}</span>
        )
      }
    </p>
    <div
      class="flex shrink-0 gap-1"
      x-data={`{
        itemData: ${productJson.replace(/'/g, "\\'")},
        state: { show: false },
        anchorRef: null,
        get inCartQty() { return $store.cartStore?.data?.items?.[this.itemData.id]?.quantity ?? 0 },
        get limit() { return this.itemData.purchaseLimit ?? 10 },
        get reachedLimit() { return this.inCartQty >= this.limit }
      }`}
      x-init="anchorRef = $el"
      :aria-describedby="'tooltip-content-' + itemData.id"
      @mouseenter="state.show = reachedLimit"
      @mouseleave="state.show = false"
    >
      <Button
        x-bind:disabled="reachedLimit"
        @click="if (!reachedLimit) { $store.cartStore.handleAddToCart({...itemData, quantity: 1}); $dispatch('open-cart') } else { state.show = true }"
        className="text-xs px-2 py-2"
      >
        <Icon name="lucide:shopping-cart" size={14} />
        Agregar
      </Button>
      <Tooltip content="Límite máximo alcanzado." position="top" />
      <Button
        href={`/product/${slug || 'uncategorized'}/${id}`}
        variant="secondary"
        className="px-2 py-2 text-xs"
      >
        <Icon name="lucide:eye" size={14} />
        Ver
      </Button>
    </div>
  </div>
</Card>
